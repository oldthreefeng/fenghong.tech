<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="google2484979e140c56f7.html" />














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  

  
    
      
    

    
  

  
    
    
    <link href="https://fonts.cat.net/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">


  <link rel="manifest" href="/images/manifest.json">


  <meta name="msapplication-config" content="/images/browserconfig.xml" />



  <meta name="keywords" content="server,Linux,Safe," />





  <link rel="alternate" href="/atom.xml" title="louis | blog" type="application/atom+xml" />






<meta name="description" content="摘要：  防火墙的概念 iptables的基本认识 iptables的组成 iptables的基本语法 iptables之forward的概念 iptables之地址转换法则 SNAT源地址转换的具体实现 DNAT目标地址转换的具体实现  安全技术 入侵检测与管理系统（Intrusion Detection Systems）：特点是不阻断任何网络访问，量化、定位来自内外网络的威胁情况，主要以提供报">
<meta name="keywords" content="server,Linux,Safe">
<meta property="og:type" content="article">
<meta property="og:title" content="iptables">
<meta property="og:url" content="https://fenghong.tech/iptables.html">
<meta property="og:site_name" content="louis | blog">
<meta property="og:description" content="摘要：  防火墙的概念 iptables的基本认识 iptables的组成 iptables的基本语法 iptables之forward的概念 iptables之地址转换法则 SNAT源地址转换的具体实现 DNAT目标地址转换的具体实现  安全技术 入侵检测与管理系统（Intrusion Detection Systems）：特点是不阻断任何网络访问，量化、定位来自内外网络的威胁情况，主要以提供报">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://fenghong.tech/images/15300856773391.png">
<meta property="og:image" content="https://fenghong.tech/images/firewall1.png">
<meta property="og:image" content="https://fenghong.tech/images/1530087711520.png">
<meta property="og:image" content="https://fenghong.tech/images/nat_test.png">
<meta property="og:updated_time" content="2018-11-07T11:31:40.440Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iptables">
<meta name="twitter:description" content="摘要：  防火墙的概念 iptables的基本认识 iptables的组成 iptables的基本语法 iptables之forward的概念 iptables之地址转换法则 SNAT源地址转换的具体实现 DNAT目标地址转换的具体实现  安全技术 入侵检测与管理系统（Intrusion Detection Systems）：特点是不阻断任何网络访问，量化、定位来自内外网络的威胁情况，主要以提供报">
<meta name="twitter:image" content="https://fenghong.tech/images/15300856773391.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://fenghong.tech/iptables.html"/>





  <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: ""
    });
  daovoice('update');
  </script>


  <title>iptables | louis | blog</title>
  








</head>


<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">louis | blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">山不在高，有仙则名；水不在深，有龙则灵。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-music">
          <a href="/music" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            music
          </a>
        </li>
      
        
        <li class="menu-item menu-item-wiki">
          <a href="http://wiki.fenghong.tech/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            wiki
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fenghong.tech/iptables.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Louis">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="louis | blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">iptables</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-26T15:59:32+08:00">
                2018-06-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/internet/" itemprop="url" rel="index">
                    <span itemprop="name">internet</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/iptables.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="iptables.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/iptables.html" class="leancloud_visitors" data-flag-title="iptables">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">热度&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
		 <span>℃</spqn>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3,625
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  16
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>摘要：</p>
<ul>
<li>防火墙的概念</li>
<li>iptables的基本认识</li>
<li>iptables的组成</li>
<li>iptables的基本语法</li>
<li>iptables之forward的概念</li>
<li>iptables之地址转换法则</li>
<li>SNAT源地址转换的具体实现</li>
<li>DNAT目标地址转换的具体实现</li>
</ul>
<h1 id="安全技术"><a href="#安全技术" class="headerlink" title="安全技术"></a>安全技术</h1><ul>
<li>入侵检测与管理系统（Intrusion Detection Systems）：特点是不阻断任何网络访问，量化、定位来自内外网络的威胁情况，主要以提供报告和事后监督为主，有针对性的指导措施和安全决策依据。一般采用旁路部署方式；</li>
<li>入侵防御系统（Intrusion Prevention System）：以透明模式工作，分析数据包的内容如：溢出攻击、拒绝服务攻击、木马、蠕虫、系统漏洞等进行准确的分析判断，在判定为攻击行为后立即予以阻断，主动而有效的保护网络的安全，一般采用在线部署方式；</li>
<li>防火墙（ FireWall ）：隔离工具，工作在网络或主机边缘，对进出网络或主机的报文，根据事先定义好的检查规则作匹配检测，对于能够被规则所匹配的报文做出相应处理的组件，基本上的实现都是默认情况下关闭所有的通过型访问，只开放允许访问的策略。</li>
</ul>
<h2 id="防火墙的分类"><a href="#防火墙的分类" class="headerlink" title="防火墙的分类"></a>防火墙的分类</h2><ul>
<li>主机防火墙：服务范围为当前主机<br>网络防火墙：服务范围为防火墙一侧的局域网</li>
<li>硬件防火墙：在专用硬件级别实现部分功能的防火墙；另一个部分功能基于软件实现，<code>Checkpoint,NetScreen</code></li>
<li>软件防火墙：运行于通用硬件平台之上的防火墙的应用软件</li>
<li>网络层防火墙：OSI下面第三层<br>应用层防火墙/代理服务器：代理网关，OSI七层</li>
</ul>
<h3 id="网络层防火墙"><a href="#网络层防火墙" class="headerlink" title="网络层防火墙"></a>网络层防火墙</h3><ul>
<li>包过滤防火墙</li>
<li><p>网络层对数据包进行选择，选择的依据是系统内设置的过滤逻辑，被称为访问控制列表（ACL），通过检查数据流中每个数据的源地址，目的地址，所用端口号和协议状态等因素，或他们的组合来确定是否允许该数据包通过.</p>
</li>
<li><p>优点：对用户来说透明，处理速度快且易于维护</p>
</li>
<li>缺点：无法检查应用层数据，如病毒等</li>
</ul>
<p><img src="/images/15300856773391.png" alt="1530085773391"></p>
<h3 id="应用层防火墙"><a href="#应用层防火墙" class="headerlink" title="应用层防火墙"></a>应用层防火墙</h3><p>应用层防火墙/代理服务型防火墙（Proxy Service）</p>
<ul>
<li>将所有跨越防火墙的网络通信链路分为两段</li>
<li>内外网用户的访问都是通过代理服务器上的“链接”来实现</li>
<li>优点：在应用层对数据进行检查，比较安全</li>
<li>缺点：增加防火墙的负载</li>
</ul>
<p><img src="/images/firewall1.png" alt="1530085779595"></p>
<h1 id="iptables的基本认识"><a href="#iptables的基本认识" class="headerlink" title="iptables的基本认识"></a>iptables的基本认识</h1><h2 id="Netfilter组件"><a href="#Netfilter组件" class="headerlink" title="Netfilter组件"></a>Netfilter组件</h2><ul>
<li>内核空间，集成在linux内核中</li>
<li>扩展各种网络服务的结构化底层框架</li>
<li><p>内核中选取五个位置放了五个hook(勾子) function(<code>INPUT、OUTPUT、FORWARD、PREROUTING、POSTROUTING</code>)，而这五个hook function向用户开放，用户可以通过一个命令工具（iptables）向其写入规则。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">]#cat config-3.10.0-693.el7.x86_64 |grep -i iptables</span><br><span class="line">CONFIG_IP_NF_IPTABLES=m</span><br><span class="line">CONFIG_IP6_NF_IPTABLES=m</span><br><span class="line"># iptables trigger is under Netfilter config (LED target)</span><br></pre></td></tr></table></figure>
</li>
<li><p>由信息过滤表（table）组成，包含控制IP包处理的规则集（rules），规则被分组放在链（chain）上</p>
</li>
<li><p>三种报文流向：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">流入本机：PREROUTING --&gt; INPUT--&gt;用户空间进程</span><br><span class="line">流出本机：用户空间进程 --&gt;OUTPUT--&gt; POSTROUTING</span><br><span class="line">转发：PREROUTING --&gt; FORWARD --&gt; POSTROUTING</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="iptables的组成"><a href="#iptables的组成" class="headerlink" title="iptables的组成"></a>iptables的组成</h2><p>iptables由四个表和五个链以及一些规则组成</p>
<ul>
<li>四个表table：filter、nat、mangle、raw</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filter表:过滤规则表，根据预定义的规则过滤符合条件的数据包</span><br><span class="line">nat表:network address translation 地址转换规则表</span><br><span class="line">mangle:修改数据标记位规则表</span><br><span class="line">	http 80     mangle 10</span><br><span class="line">	https 443   mangle 10</span><br><span class="line">Raw:关闭NAT表上启用的连接跟踪机制，加快封包穿越防火墙速度</span><br><span class="line">优先级由高到低的顺序为:raw--&gt;mangle--&gt;nat--&gt;filter</span><br></pre></td></tr></table></figure>
<ul>
<li>五个内置链chain<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">INPUT</span><br><span class="line">OUTPUT</span><br><span class="line">FORWARD</span><br><span class="line">PREROUTING</span><br><span class="line">POSTROUTING</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Netfilter表与chain对应联系</p>
<p><img src="/images/1530087711520.png" alt="1530087711520"></p>
<h2 id="iptables-命令"><a href="#iptables-命令" class="headerlink" title="iptables 命令"></a>iptables 命令</h2><ul>
<li>DESCRIPTION</li>
</ul>
<blockquote>
<p>Iptables  and  ip6tables  are used to set up, maintain, and inspect the tables of IPv4 and IPv6 packet filter rules in the Linux kernel.  Several different  tables may  be  defined.   Each  table contains a number of built-in chains and may also contain user-defined chains.</p>
<p>Each chain is a list of rules which can match a set of packets.  Each rule specifies what to do with a packet that matches.  This is called a ‘target’, which maybe a jump to a user-defined chain in the same table.</p>
</blockquote>
<ul>
<li><p>选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">iptables [-t table] &#123;-A|-C|-D&#125; chain rule-specification</span><br><span class="line">ip6tables [-t table] &#123;-A|-C|-D&#125; chain rule-specification</span><br><span class="line">iptables [-t table] -I chain [rulenum] rule-specification</span><br><span class="line">iptables [-t table] -R chain rulenum rule-specification</span><br><span class="line">iptables [-t table] -D chain rulenum</span><br><span class="line">iptables [-t table] -S [chain [rulenum]]</span><br><span class="line">iptables [-t table] &#123;-F|-L|-Z&#125; [chain [rulenum]] [options...]</span><br><span class="line">iptables [-t table] -N chain</span><br><span class="line">iptables [-t table] -X [chain]</span><br><span class="line">iptables [-t table] -P chain target</span><br><span class="line">iptables [-t table] -E old-chain-name new-chain-name</span><br><span class="line">rule-specification = [matches...] [target]</span><br></pre></td></tr></table></figure>
</li>
<li><p>系统默认的防火墙规则关闭</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">service iptables stop</span><br><span class="line">chkconfig iptables off</span><br></pre></td></tr></table></figure>
</li>
<li><p>自己编写防火墙规则。</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">]# iptables -t filter -A INPUT -s 192.168.1.11 -j REJECT</span><br><span class="line">]# iptables -t filter -A INPUT -s 192.168.1.0/24 -j REJECT</span><br><span class="line">]# iptables -t filter -I INPUT 2 -s 192.168.1.18 -j REJECT</span><br><span class="line">]# iptables -vnL --line-numbers</span><br><span class="line">]# iptables -D  INPUT 1</span><br></pre></td></tr></table></figure>
<ol>
<li><p>链管理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-N：new, 自定义一条新的规则链</span><br><span class="line">-X：delete，删除自定义的空的规则链</span><br><span class="line">-P：Policy，设置默认策略；对filter表中的链而言，其默认策略有：</span><br><span class="line">	ACCEPT：接受</span><br><span class="line">	DROP：丢弃</span><br><span class="line">-E：重命名自定义链；引用计数不为0的自定义链不能够被重命名，也不能被删除</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-L：list, 列出指定鏈上的所有规则，本选项须置后</span><br><span class="line">-n：numberic，以数字格式显示地址和端口号</span><br><span class="line">-v：verbose，详细信息</span><br><span class="line">-vv 更详细</span><br><span class="line">-x：exactly，显示计数器结果的精确值,而非单位转换后的易读值</span><br><span class="line">--line-numbers：显示规则的序号</span><br><span class="line">常用组合：</span><br><span class="line">--vnL</span><br><span class="line">--vvnxL --line-numbers</span><br><span class="line">-S selected,以iptables-save 命令格式显示链上规则</span><br></pre></td></tr></table></figure>
</li>
<li><p>规则管理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-A：append，追加</span><br><span class="line">-I：insert, 插入，要指明插入至的规则编号，默认为第一条</span><br><span class="line">-D：delete，删除</span><br><span class="line">(1) 指明规则序号</span><br><span class="line">(2) 指明规则本身</span><br><span class="line">-R：replace，替换指定链上的指定规则编号</span><br><span class="line">-F：flush，清空指定的规则链</span><br><span class="line">-Z：zero，置零</span><br><span class="line">iptables的每条规则都有两个计数器</span><br><span class="line">(1) 匹配到的报文的个数</span><br><span class="line">(2) 匹配到的所有报文的大小之和</span><br><span class="line">chain： PREROUTING，INPUT，FORWARD，OUTPUT，POSTROUTING</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="基本用法和扩展用法"><a href="#基本用法和扩展用法" class="headerlink" title="基本用法和扩展用法"></a>基本用法和扩展用法</h2><ol>
<li>基本匹配条件：无需加载模块，由<code>iptables/netfilter</code>自行提供</li>
</ol>
<ul>
<li><p><code>[!] -s, --source address[/mask][,...]</code>：源IP地址或范围</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">]# iptables -A INPUT -s 192.168.1.8 -p tcp --dport 139 -j REJECT</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>[!] -d, --destination address[/mask][,...]</code>：目标IP地址或范围</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">]# iptables -A OUTPUT -d 192.168.1.0/24 -j ACCEPT</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>[!] -p, --protocol protocol</code>：指定协议，可使用数字如0（all）<br>protocol: tcp, udp, icmp, icmpv6, udplite,esp, ah, sctp, mh or “all“ 参看：/etc/protocols</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">]# iptables -A INPUT -s 192.168.1.8 -p tcp --dport 445 -j REJECT</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>[!] -i, --in-interface name</code>：报文流入的接口；只能应用于数据报文流入环节，只应用于INPUT、FORWARD、PREROUTING 链</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]# iptables -A OUTPUT -o lo -j ACCEPT</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>[!] -o, --out-interface name：</code>报文流出的接口；只能应用于数据报文流出的环节，只应用于 FORWARD、OUTPUT 、 POSTROUTING 链</p>
</li>
</ul>
<ol start="2">
<li>扩展匹配条件：需要加载扩展模块（/usr/lib64/xtables/*.so），方可生效</li>
</ol>
<ul>
<li>查看帮助 man iptables-extensions</li>
<li>(1)隐式扩展：在使用-p选项指明了特定的协议时，无需再用-m选项指明扩展模块的扩展</li>
</ul>
<p>机制，不需要手动加载扩展模块</p>
<ul>
<li><p>tcp协议的扩展选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[!] --source-port, --sport port[:port]：匹配报文源端口,可为端口范围</span><br><span class="line">[!] --destination-port,--dport port[:port]：匹配报文目标端口,可为范围</span><br><span class="line">[!] --tcp-flags mask comp</span><br></pre></td></tr></table></figure>
</li>
<li><p>显式扩展：必须使用-m选项指明要调用的扩展模块的扩展机制，要手动加载扩展模块</p>
</li>
</ul>
<p><code>[-m matchname [per-match-options]]</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">]# iptables -A INPUT -p tcp --syn -j REJECT    #拒绝首次tcp链接,已经链接的不拒绝</span><br><span class="line">]# iptables -A INPUT -p icmp --icmp-type 8 -j REJECT  #禁ping</span><br><span class="line">]# rpm -ql iptables | grep multiport  #多端口</span><br><span class="line">/usr/lib64/xtables/libxt_multiport.so</span><br><span class="line">]# iptables -A INPUT -p tcp -m  multiport --dport 21,80,139,445 -j REJECT</span><br><span class="line">]# iptables -A INPUT -s IP -j ACCEPT</span><br><span class="line">]# iptables -A OUTPUT -s IP -j ACCEPT</span><br><span class="line">]# iptables -A INPUT -j REJECT</span><br><span class="line">]# iptables -A OUTPUT -j REJECT</span><br><span class="line">]# iptables -A INPUT -p tcp -m  multiport --dport 22,80,139,445 -j ACCEPT</span><br><span class="line">]# iptables -A OUTPUT -p tcp -m  multiport --sport 22,80,139,445 -j ACCEPT</span><br></pre></td></tr></table></figure>
<p>tips：利用telnet测试是否filter成功</p>
<ol start="3">
<li>自定义链</li>
</ol>
<p>增加自定义链<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -N WEB</span><br><span class="line">iptables -A WEB -P tcp -m multiport --dports 80,443 -j ACCEPT</span><br><span class="line">iptables -I INPUT -s 192.168.1.0/24 -j WEB</span><br></pre></td></tr></table></figure></p>
<p>删除自定义链<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -D INPUT 1</span><br><span class="line">iptables -D WEB 1</span><br><span class="line">iptables -X WEB</span><br></pre></td></tr></table></figure></p>
<ol start="4">
<li>string扩展</li>
</ol>
<p>对报文中的应用层数据做字符串模式匹配检测</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--algo &#123;bm|kmp&#125;：字符串匹配检测算法</span><br><span class="line">bm：Boyer-Moore</span><br><span class="line">kmp：Knuth-Pratt-Morris</span><br><span class="line">--from offset 开始偏移</span><br><span class="line">--to offset 结束偏移</span><br><span class="line">[!] --string pattern：要检测的字符串模式</span><br><span class="line">[!] --hex-string pattern：要检测字符串模式，16进制格式</span><br></pre></td></tr></table></figure>
<p>例如：只要匹配到google的，全部拒绝。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A OUTPUT -m string --algo bm --string &quot;google&quot; -j REJECT</span><br></pre></td></tr></table></figure></p>
<ol start="5">
<li>time扩展</li>
</ol>
<p>根据将报文到达的时间与指定的时间范围进行匹配<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--datestart YYYY[-MM[-DD[Thh[:mm[:ss]]]]] 日期</span><br><span class="line">--datestop YYYY[-MM[-DD[Thh[:mm[:ss]]]]]</span><br><span class="line">--timestart hh:mm[:ss] 时间</span><br><span class="line">--timestop hh:mm[:ss]</span><br><span class="line">[!] --monthdays day[,day...] 每个月的几号</span><br><span class="line">[!] --weekdays day[,day...] 星期几</span><br><span class="line">--kerneltz：内核时区，不建议使用，CentOS7系统默认为UTC</span><br></pre></td></tr></table></figure></p>
<p>例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -s 172.20.0.0/16 -d 172.16.100.10 -p tcp --dport 80 -m time --timestart 14:30 --timestop 18:30 --weekdays Sat,Sun --kerneltz -j DROP</span><br></pre></td></tr></table></figure></p>
<ol start="6">
<li>state扩展<br>根据”连接追踪机制“去检查连接的状态，较耗资源，用的也相对多，例如nat技术。</li>
</ol>
<ul>
<li>conntrack机制：追踪本机上的请求和响应之间的关系</li>
<li>状态有如下几种：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NEW：新发出请求；连接追踪信息库中不存在此连接的相关信息条目，因此，将其识别为第一次发出的请求</span><br><span class="line">ESTABLISHED：NEW状态之后，连接追踪信息库中为其建立的条目失效之前期间内所进行的通信状态</span><br><span class="line">RELATED：新发起的但与已有连接相关联的连接，如：ftp协议中的数据连接与命令连接之间的关系</span><br><span class="line">INVALID：无效的连接，如flag标记不正确</span><br><span class="line">UNTRACKED：未进行追踪的连接，如raw表中关闭追踪</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT 1 -s 192.168.1.0/24 -m state --state NEW -j REJECT</span><br><span class="line">iptables -I INPPUT 1  -m state --state ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure>
<p>iptables的链接跟踪表最大容量为<code>/proc/sys/net/nf_conntrack_max</code>，各种状态的超时链接会从表中删除；当模板满载时，后续连接可能会超时</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(1) 加大 nf_conntrack_max 值</span><br><span class="line">vi /etc/sysctl.conf</span><br><span class="line">net.nf_conntrack_max = 393216</span><br><span class="line">net.netfilter.nf_conntrack_max = 393216</span><br><span class="line">(2)  降低 nf_conntrack timeout 时间</span><br><span class="line">vi /etc/sysctl.conf</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_established = 300</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120</span><br></pre></td></tr></table></figure>
<h2 id="iptables策略总结"><a href="#iptables策略总结" class="headerlink" title="iptables策略总结"></a>iptables策略总结</h2><p>任何不允许的访问，应该在请求到达时给予拒绝<br>规则在链接上的次序即为其检查时的生效次序</p>
<ul>
<li>基于上述，规则优化</li>
</ul>
<blockquote>
<ol>
<li>安全放行所有入站和出站的状态为ESTABLISHED状态连接</li>
<li>谨慎放行入站的新请求</li>
<li>有特殊目的限制访问功能，要在放行规则之前加以拒绝</li>
<li>同类规则（访问同一应用），匹配范围小的放在前面，用于特殊处理</li>
<li>不同类的规则（访问不同应用），匹配范围大的放在前面</li>
<li>应该将那些可由一条规则能够描述的多个规则合并为一条</li>
<li>设置默认策略，建议白名单（只放行特定连接）<br>a. iptables -P，不建议<br>b. 建议在规则的最后定义规则做为默认策略</li>
</ol>
</blockquote>
<h1 id="iptables具体应用试验"><a href="#iptables具体应用试验" class="headerlink" title="iptables具体应用试验"></a>iptables具体应用试验</h1><ul>
<li>试验拓扑图如下:</li>
</ul>
<p>内网用户：<code>192.168.1.0/24</code> </p>
<p>router：<code>192.168.1.0/24 ; 10.0.0.254/8</code>,注意：这里假想<code>10.0.0.0/8</code>为所有的外网用户，且用linux主机充当。</p>
<p>外网：<code>10.0.0.0/8</code> ； 外网web：<code>10.0.0.8/8</code> ； 外网的client：<code>10.0.0.17/8</code></p>
<p><img src="/images/nat_test.png" alt="nat_test"></p>
<h2 id="实现内网安全"><a href="#实现内网安全" class="headerlink" title="实现内网安全"></a>实现内网安全</h2><p>只需在防火墙上的router上添加几条规则即可。</p>
<p>要求：有客户端想访问192.168.1.18:80的web资源，并且内网用户能访问外网</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">]# echo &quot;net.ipv4.ip_forward = 1&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">]# systcl -p</span><br><span class="line">]# iptables -A FORWARD -j REJECT</span><br><span class="line">]# iptables -I FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">]# iptables -I FORWARD 2 -s 192.168.1.0/24 -d 0.0.0.0/0  -m state --state NEW -j ACCEPT</span><br><span class="line">]# iptables -I FORWARD 2 -d 192.168.1.0/24 -p tcp --dport 80 -m state --state NEW -j ACCEPT</span><br></pre></td></tr></table></figure>
<h2 id="NAT"><a href="#NAT" class="headerlink" title="NAT"></a>NAT</h2><ul>
<li>NAT: <code>network address translation</code></li>
</ul>
<blockquote>
<p>PREROUTING，INPUT，OUTPUT，POSTROUTING<br>请求报文：修改源/目标IP，由定义如何修改<br>响应报文：修改源/目标IP，根据跟踪机制自动实现</p>
</blockquote>
<ul>
<li>SNAT：<code>source NAT POSTROUTING, INPUT</code></li>
</ul>
<blockquote>
<p>让本地网络中的主机通过某一特定地址访问外部网络，实现地址伪装<br>请求报文：修改源IP</p>
</blockquote>
<ul>
<li>DNAT：destination NAT PREROUTING , OUTPUT</li>
</ul>
<blockquote>
<p>把本地网络中的主机上的某服务开放给外部网络访问(发布服务和端口映射)，但隐藏真实IP<br>请求报文：修改目标IP</p>
</blockquote>
<ul>
<li>PNAT: port nat，端口和IP都进行修改</li>
</ul>
<h2 id="SNAT"><a href="#SNAT" class="headerlink" title="SNAT"></a>SNAT</h2><ul>
<li>SNAT：固定IP</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--to-source [ipaddr[-ipaddr]][:port[-port]]</span><br><span class="line">--random</span><br><span class="line">iptables -t nat -A POSTROUTING -s LocalNET -j SNAT --t-soutce ExtIP</span><br></pre></td></tr></table></figure>
<p>示例，依旧利用上述网络拓扑试验图，在router上设置，：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">]# echo &quot;net.ipv4.ip_forward = 1&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">]# sysctl -p</span><br><span class="line">]# iptables -t nat -A POSTROUTING -s 192.168.1.0/24 ! -d 192.168.1.0/24 -j SNAT --to-source 10.0.0.254</span><br></pre></td></tr></table></figure>
<ul>
<li>MASQUERADE：动态IP，如拨号网络</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--to-ports port[-port]</span><br><span class="line">--random</span><br><span class="line">iptables -t nat -A POSTROUTING -s LocalNET ! -d LocalNet -j MASQUERADE</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s  192.168.1.0/24  ! -d 192.168.1.0/24  -j MASQUERADE</span><br></pre></td></tr></table></figure>
<h2 id="DNAT"><a href="#DNAT" class="headerlink" title="DNAT"></a>DNAT</h2><ul>
<li><p>DNAT</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--to-destination [ipaddr[-ipaddr]][:port[-port]]</span><br><span class="line">iptables -t nat -A PREROUTING -d ExtIP -p tcp|udp --dport PORT -j DNAT --to-destination InterSeverIP[:PORT]</span><br></pre></td></tr></table></figure>
</li>
<li><p>示例，依旧是上面的网络拓扑试验图router上进行设置： </p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">]# iptables -t nat -A PREROUTING -s 0/0 -d 10.0.0.254 -p tcp --dport 80 -j DNAT --to-destination 192.168.1.18:80</span><br><span class="line">]# iptables -vnL -t nat</span><br></pre></td></tr></table></figure>
<ul>
<li>端口转发</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">]# iptables -t nat -A PREROUTING -d 192.168.1.18 -p tcp --dport 80 -j REDIRECT --to-port 8080</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

<div>
  
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

  
</div>

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Louis
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://fenghong.tech/iptables.html" title="iptables">https://fenghong.tech/iptables.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/server/" rel="tag"> <i class="fa fa-tag"></i> server</a>
          
            <a href="/tags/Linux/" rel="tag"> <i class="fa fa-tag"></i> Linux</a>
          
            <a href="/tags/Safe/" rel="tag"> <i class="fa fa-tag"></i> Safe</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/samba.html" rel="next" title="Samba">
                <i class="fa fa-chevron-left"></i> Samba
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/iptables1.html" rel="prev" title="IptablesTest">
                IptablesTest <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="Louis" />
            
              <p class="site-author-name" itemprop="name">Louis</p>
              <p class="site-description motion-element" itemprop="description">每一个不曾起舞的日子都是对生命的辜负</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">52</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">44</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/oldthreefeng" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:louisehong4168@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-mail"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://fenghong.tech" target="_blank" title="MY Page">
                      
                        <i class="fa fa-fw fa-facebook"></i>MY Page</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://instagram.com/louisehong4168" target="_blank" title="Instagram">
                      
                        <i class="fa fa-fw fa-instagram"></i>Instagram</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://blog.51cto.com/13698281" target="_blank" title="Blog">
                      
                        <i class="fa fa-fw fa-skype"></i>Blog</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://fontawesome.com/icons" title="Awesome" target="_blank">Awesome</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.dongfei.tech/" title="东飞同学" target="_blank">东飞同学</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#安全技术"><span class="nav-number">1.</span> <span class="nav-text">安全技术</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#防火墙的分类"><span class="nav-number">1.1.</span> <span class="nav-text">防火墙的分类</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#网络层防火墙"><span class="nav-number">1.1.1.</span> <span class="nav-text">网络层防火墙</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#应用层防火墙"><span class="nav-number">1.1.2.</span> <span class="nav-text">应用层防火墙</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#iptables的基本认识"><span class="nav-number">2.</span> <span class="nav-text">iptables的基本认识</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Netfilter组件"><span class="nav-number">2.1.</span> <span class="nav-text">Netfilter组件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iptables的组成"><span class="nav-number">2.2.</span> <span class="nav-text">iptables的组成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iptables-命令"><span class="nav-number">2.3.</span> <span class="nav-text">iptables 命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基本用法和扩展用法"><span class="nav-number">2.4.</span> <span class="nav-text">基本用法和扩展用法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iptables策略总结"><span class="nav-number">2.5.</span> <span class="nav-text">iptables策略总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#iptables具体应用试验"><span class="nav-number">3.</span> <span class="nav-text">iptables具体应用试验</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#实现内网安全"><span class="nav-number">3.1.</span> <span class="nav-text">实现内网安全</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NAT"><span class="nav-number">3.2.</span> <span class="nav-text">NAT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SNAT"><span class="nav-number">3.3.</span> <span class="nav-text">SNAT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DNAT"><span class="nav-number">3.4.</span> <span class="nav-text">DNAT</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Louis</span>

  
</div>








<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">全站共140.6k字</span>
</div>
<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://louis.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://fenghong.tech/iptables.html';
          this.page.identifier = 'iptables.html';
          this.page.title = 'iptables';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://louis.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  

















  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("WUrOTFdNyFLyPvVTH21BtCYh-gzGzoHsz", "7Mybsg0GSjOAiBwjuLWlPsOq");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/love.js"></script>
